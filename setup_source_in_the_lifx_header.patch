# HG changeset patch
# Parent  c128b73a419788def1f3d8a1b4520a842d65c14b
Setup the LIFX client source to get unicast responses.

This should significantly improve both latency and throughput.

diff --git a/CMakeLists.txt b/CMakeLists.txt
--- a/CMakeLists.txt
+++ b/CMakeLists.txt
@@ -5,7 +5,7 @@
 
 SET(CPACK_PACKAGE_VERSION_MAJOR "1")
 SET(CPACK_PACKAGE_VERSION_MINOR "1")
-SET(CPACK_PACKAGE_VERSION_PATCH "0")
+SET(CPACK_PACKAGE_VERSION_PATCH "1")
 SET(LIGHTSD_VERSION "${CPACK_PACKAGE_VERSION_MAJOR}.${CPACK_PACKAGE_VERSION_MINOR}.${CPACK_PACKAGE_VERSION_PATCH}")
 
 MESSAGE(STATUS "lightsd version: ${LIGHTSD_VERSION}")
diff --git a/core/daemon.c b/core/daemon.c
--- a/core/daemon.c
+++ b/core/daemon.c
@@ -400,6 +400,28 @@
     return written == pidlen;
 }
 
+uint32_t
+lgtd_daemon_randuint32(void)
+{
+    int fd = open("/dev/urandom", O_RDONLY);
+    if (fd == -1) {
+        lgtd_err(1, "couldn't open /dev/urandom");
+    }
+
+    uint32_t rv;
+    int nbytes = read(fd, &rv, sizeof(rv));
+    if (nbytes != sizeof(rv)) {
+        close(fd);
+        lgtd_err(
+            1, "couln't fetch %ju bytes from /dev/urandom",
+            sizeof((uintmax_t)rv)
+        );
+    }
+
+    close(fd);
+    return rv;
+}
+
 int
 lgtd_daemon_syslog_facilitytoi(const char *facility)
 {
diff --git a/core/daemon.h b/core/daemon.h
--- a/core/daemon.h
+++ b/core/daemon.h
@@ -36,6 +36,7 @@
 bool lgtd_daemon_write_pidfile(const char *);
 void lgtd_daemon_drop_privileges(void);
 bool lgtd_daemon_makedirs(const char *);
+uint32_t lgtd_daemon_randuint32(void);
 
 int lgtd_daemon_syslog_facilitytoi(const char *);
 void lgtd_daemon_syslog_open(const char *, enum lgtd_verbosity, int);
diff --git a/core/lightsd.c b/core/lightsd.c
--- a/core/lightsd.c
+++ b/core/lightsd.c
@@ -336,7 +336,7 @@
 
     lgtd_daemon_die_if_running_as_root_unless_requested(lgtd_opts.user);
 
-    lgtd_lifx_wire_load_packet_info_map();
+    lgtd_lifx_wire_setup();
     if (!lgtd_lifx_discovery_setup() || !lgtd_lifx_broadcast_setup()) {
         lgtd_err(1, "can't setup lightsd");
     }
diff --git a/lifx/wire_proto.c b/lifx/wire_proto.c
--- a/lifx/wire_proto.c
+++ b/lifx/wire_proto.c
@@ -35,6 +35,7 @@
 #include "core/time_monotonic.h"
 #include "bulb.h"
 #include "gateway.h"
+#include "core/daemon.h"
 #include "core/lightsd.h"
 
 const union lgtd_lifx_target LGTD_LIFX_UNSPEC_TARGET = { .tags = 0 };
@@ -50,6 +51,8 @@
    13, 18,  8, 12,  7,  6,  5, 63
 };
 
+static uint32_t lgtd_lifx_client_id = 0;
+
 static struct lgtd_lifx_packet_info_map lgtd_lifx_packet_info =
     RB_INITIALIZER(&lgtd_lifx_packets_infos);
 
@@ -95,7 +98,7 @@
     );
 }
 
-void
+static void
 lgtd_lifx_wire_load_packet_info_map(void)
 {
 #define DECODER(x)  ((void (*)(void *))(x))
@@ -465,6 +468,15 @@
     return RB_FIND(lgtd_lifx_packet_info_map, &lgtd_lifx_packet_info, &pkt_info);
 }
 
+void
+lgtd_lifx_wire_setup(void)
+{
+    lgtd_lifx_wire_load_packet_info_map();
+    do {
+        lgtd_lifx_client_id = lgtd_daemon_randuint32();
+    } while (!lgtd_lifx_client_id);
+}
+
 
 #define WAVEFORM_ENTRY(e) { .str = e, .len = sizeof(e) - 1 }
 const struct lgtd_lifx_waveform_string_id lgtd_lifx_waveform_table[] = {
@@ -534,6 +546,7 @@
     }
     hdr->at_time = htole64(hdr->at_time);
     hdr->packet_type = htole16(hdr->packet_type);
+    hdr->source = htole32(hdr->source); // not strictly necessary but eh.
 }
 
 // Convert all the fields in the header to the host endianness.
@@ -554,6 +567,7 @@
     }
     hdr->at_time = le64toh(hdr->at_time);
     hdr->packet_type = le16toh(hdr->packet_type);
+    hdr->source = le32toh(hdr->source);
 }
 
 const struct lgtd_lifx_packet_info *
@@ -564,6 +578,7 @@
                             enum lgtd_lifx_packet_type packet_type)
 {
     assert(hdr);
+    assert(lgtd_lifx_client_id);
 
     const struct lgtd_lifx_packet_info *pkt_info =
         lgtd_lifx_wire_get_packet_info(packet_type);
@@ -571,6 +586,7 @@
     assert(pkt_info);
 
     memset(hdr, 0, sizeof(*hdr));
+    hdr->source = lgtd_lifx_client_id;
     hdr->size = pkt_info->size + sizeof(*hdr);
     hdr->packet_type = packet_type;
     if (site) {
diff --git a/lifx/wire_proto.h b/lifx/wire_proto.h
--- a/lifx/wire_proto.h
+++ b/lifx/wire_proto.h
@@ -61,8 +61,16 @@
     //! - tagged: true when the target field holds tags;
     //! - origin: LIFX internal use, should be 0.
     uint16le_t      protocol;
-    //! Here is what LIFXKit says about it, maybe it's related to zigbee:
-    //! Message source identifier from NAT table (Internal LIFX use)
+    //! http://lan.developer.lifx.com/v2.0/docs/header-description
+    //! The source identifier allows each client to provide an unique value,
+    //! which will be included by the LIFX device in any message that is sent
+    //! in response to a message sent by the client. If the source identifier
+    //! is a non-zero value, then the LIFX device will send a unicast message
+    //! to the source IP address and port that the client used to send the
+    //! originating message. If the source identifier is a zero value, then the
+    //! LIFX device may send a broadcast message that can be received by all
+    //! clients on the same sub-net. See _ack_required_ and _res_required_
+    //! fields in the Frame Address.
     uint32le_t      source;
     union {
         //! All targeted tags ORed together.
@@ -392,7 +400,8 @@
     lgtd_lifx_wire_print_nsec_timestamp((ts), (arr), sizeof((arr)))
 
 const struct lgtd_lifx_packet_info *lgtd_lifx_wire_get_packet_info(enum lgtd_lifx_packet_type);
-void lgtd_lifx_wire_load_packet_info_map(void);
+
+void lgtd_lifx_wire_setup(void);
 
 const struct lgtd_lifx_packet_info *lgtd_lifx_wire_setup_header(struct lgtd_lifx_packet_header *,
                                                                  enum lgtd_lifx_target_type,
diff --git a/tests/core/client/CMakeLists.txt b/tests/core/client/CMakeLists.txt
--- a/tests/core/client/CMakeLists.txt
+++ b/tests/core/client/CMakeLists.txt
@@ -10,7 +10,6 @@
     ${LIGHTSD_SOURCE_DIR}/core/utils.c
     ${LIGHTSD_SOURCE_DIR}/lifx/bulb.c
     ${LIGHTSD_SOURCE_DIR}/lifx/tagging.c
-    ${LIGHTSD_SOURCE_DIR}/lifx/wire_proto.c
     ${CMAKE_CURRENT_SOURCE_DIR}/../tests_shims.c
     ${CMAKE_CURRENT_SOURCE_DIR}/../tests_utils.c
 )
diff --git a/tests/core/daemon/CMakeLists.txt b/tests/core/daemon/CMakeLists.txt
--- a/tests/core/daemon/CMakeLists.txt
+++ b/tests/core/daemon/CMakeLists.txt
@@ -10,7 +10,6 @@
     ${LIGHTSD_SOURCE_DIR}/core/utils.c
     ${LIGHTSD_SOURCE_DIR}/lifx/bulb.c
     ${LIGHTSD_SOURCE_DIR}/lifx/tagging.c
-    ${LIGHTSD_SOURCE_DIR}/lifx/wire_proto.c
     ${CMAKE_CURRENT_SOURCE_DIR}/../tests_shims.c
     ${CMAKE_CURRENT_SOURCE_DIR}/../tests_utils.c
 )
diff --git a/tests/core/daemon/test_daemon_randuint32.c b/tests/core/daemon/test_daemon_randuint32.c
new file mode 100644
--- /dev/null
+++ b/tests/core/daemon/test_daemon_randuint32.c
@@ -0,0 +1,94 @@
+#include <sys/types.h>
+
+int mock_open(const char *, int, ...);
+ssize_t mock_read(int, void *, size_t);
+int mock_close(int);
+
+#define open(fp, flags, ...) mock_open(fp, flags, ##__VA_ARGS__)
+#define read(fd, buf, sz) mock_read(fd, buf, sz)
+#define close(fd) mock_close(fd)
+
+#include "daemon.c"
+
+#include "mock_gateway.h"
+#include "mock_pipe.h"
+#include "mock_router.h"
+#include "mock_log.h"
+#include "mock_timer.h"
+
+static const int MOCK_RANDOM_NUMBER = 0x72616e64;
+
+int mock_open_call_count = 0;
+
+int
+mock_open(const char *fp, int flags, ...)
+{
+    mock_open_call_count++;
+
+    if (strcmp(fp, "/dev/urandom")) {
+        errx(1, "got fp %s (expected /dev/urandom)", fp);
+    }
+
+    if (flags != O_RDONLY) {
+        errx(1, "got flags %#x (expected %#x)", flags, O_RDONLY);
+    }
+
+    return 42;
+}
+
+int mock_read_call_count = 0;
+
+ssize_t
+mock_read(int fd, void *buf, size_t nbytes)
+{
+    mock_read_call_count++;
+
+    if (fd != 42) {
+        errx(1, "got fd %d (expected 42)", fd);
+    }
+
+    if (!buf) {
+        errx(1, "missing buf");
+    }
+
+    if (nbytes != 4) {
+        errx(1, "got nbytes %ju (expected 4)", (uintmax_t)nbytes);
+    }
+
+    memcpy(buf, &MOCK_RANDOM_NUMBER, sizeof(MOCK_RANDOM_NUMBER));
+
+    return nbytes;
+}
+
+int mock_close_call_count = 0;
+
+int
+mock_close(int fd)
+{
+    mock_close_call_count++;
+
+    if (fd != 42) {
+        errx(1, "got fd %d (expected 42)", fd);
+    }
+
+    return 0;
+}
+
+int
+main(void)
+{
+    if (lgtd_daemon_randuint32() != MOCK_RANDOM_NUMBER) {
+        errx(1, "got unexpected value from randuint32");
+    }
+    if (mock_open_call_count != 1) {
+        errx(1, "open wasn't once");
+    }
+    if (mock_read_call_count != 1) {
+        errx(1, "read wasn't once");
+    }
+    if (mock_close_call_count != 1) {
+        errx(1, "close wasn't once");
+    }
+
+    return 0;
+}
diff --git a/tests/core/daemon/test_daemon_writepidfile.c b/tests/core/daemon/test_daemon_writepidfile.c
--- a/tests/core/daemon/test_daemon_writepidfile.c
+++ b/tests/core/daemon/test_daemon_writepidfile.c
@@ -46,7 +46,7 @@
     va_end(ap);
 
     if (strcmp(fp, "/test.pid")) {
-        lgtd_errx(1, "got fp %s (expected test.pid)", fp);
+        lgtd_errx(1, "got fp %s (expected /test.pid)", fp);
     }
 
     int expected_flags = O_CREAT|O_WRONLY|O_TRUNC;
diff --git a/tests/core/jsonrpc/CMakeLists.txt b/tests/core/jsonrpc/CMakeLists.txt
--- a/tests/core/jsonrpc/CMakeLists.txt
+++ b/tests/core/jsonrpc/CMakeLists.txt
@@ -8,7 +8,6 @@
     ${LIGHTSD_SOURCE_DIR}/core/jsmn.c
     ${LIGHTSD_SOURCE_DIR}/core/stats.c
     ${LIGHTSD_SOURCE_DIR}/core/utils.c
-    ${LIGHTSD_SOURCE_DIR}/lifx/wire_proto.c
     ${LIGHTSD_SOURCE_DIR}/lifx/bulb.c
     ${CMAKE_CURRENT_SOURCE_DIR}/../tests_shims.c
     ${CMAKE_CURRENT_SOURCE_DIR}/../tests_utils.c
diff --git a/tests/core/jsonrpc/test_jsonrpc_batch.c b/tests/core/jsonrpc/test_jsonrpc_batch.c
--- a/tests/core/jsonrpc/test_jsonrpc_batch.c
+++ b/tests/core/jsonrpc/test_jsonrpc_batch.c
@@ -5,6 +5,7 @@
 #define MOCKED_LGTD_PROTO_GET_LIGHT_STATE
 #define MOCKED_LGTD_PROTO_POWER_ON
 #include "mock_proto.h"
+#include "mock_wire_proto.h"
 #include "test_jsonrpc_utils.h"
 
 static int power_on_call_count = 0;
diff --git a/tests/core/jsonrpc/test_jsonrpc_batch_notifications_only.c b/tests/core/jsonrpc/test_jsonrpc_batch_notifications_only.c
--- a/tests/core/jsonrpc/test_jsonrpc_batch_notifications_only.c
+++ b/tests/core/jsonrpc/test_jsonrpc_batch_notifications_only.c
@@ -5,6 +5,7 @@
 #define MOCKED_LGTD_PROTO_GET_LIGHT_STATE
 #define MOCKED_LGTD_PROTO_POWER_ON
 #include "mock_proto.h"
+#include "mock_wire_proto.h"
 #include "test_jsonrpc_utils.h"
 
 static int power_on_call_count = 0;
diff --git a/tests/core/jsonrpc/test_jsonrpc_batch_one_invalid_request.c b/tests/core/jsonrpc/test_jsonrpc_batch_one_invalid_request.c
--- a/tests/core/jsonrpc/test_jsonrpc_batch_one_invalid_request.c
+++ b/tests/core/jsonrpc/test_jsonrpc_batch_one_invalid_request.c
@@ -4,6 +4,7 @@
 #include "mock_log.h"
 #define MOCKED_LGTD_PROTO_POWER_ON
 #include "mock_proto.h"
+#include "mock_wire_proto.h"
 #include "test_jsonrpc_utils.h"
 
 static int power_on_call_count = 0;
diff --git a/tests/core/jsonrpc/test_jsonrpc_batch_one_notification.c b/tests/core/jsonrpc/test_jsonrpc_batch_one_notification.c
--- a/tests/core/jsonrpc/test_jsonrpc_batch_one_notification.c
+++ b/tests/core/jsonrpc/test_jsonrpc_batch_one_notification.c
@@ -5,6 +5,7 @@
 #define MOCKED_LGTD_PROTO_GET_LIGHT_STATE
 #define MOCKED_LGTD_PROTO_POWER_ON
 #include "mock_proto.h"
+#include "mock_wire_proto.h"
 #include "test_jsonrpc_utils.h"
 
 static int power_on_call_count = 0;
diff --git a/tests/core/jsonrpc/test_jsonrpc_build_target_list.c b/tests/core/jsonrpc/test_jsonrpc_build_target_list.c
--- a/tests/core/jsonrpc/test_jsonrpc_build_target_list.c
+++ b/tests/core/jsonrpc/test_jsonrpc_build_target_list.c
@@ -3,6 +3,7 @@
 #include "mock_client_buf.h"
 #include "mock_log.h"
 #include "mock_proto.h"
+#include "mock_wire_proto.h"
 #include "test_jsonrpc_utils.h"
 
 static void
diff --git a/tests/core/jsonrpc/test_jsonrpc_check_and_call_power_off.c b/tests/core/jsonrpc/test_jsonrpc_check_and_call_power_off.c
--- a/tests/core/jsonrpc/test_jsonrpc_check_and_call_power_off.c
+++ b/tests/core/jsonrpc/test_jsonrpc_check_and_call_power_off.c
@@ -4,6 +4,7 @@
 #include "mock_log.h"
 #define MOCKED_LGTD_PROTO_POWER_OFF
 #include "mock_proto.h"
+#include "mock_wire_proto.h"
 
 #include "test_jsonrpc_utils.h"
 
diff --git a/tests/core/jsonrpc/test_jsonrpc_check_and_call_power_off_missing_target.c b/tests/core/jsonrpc/test_jsonrpc_check_and_call_power_off_missing_target.c
--- a/tests/core/jsonrpc/test_jsonrpc_check_and_call_power_off_missing_target.c
+++ b/tests/core/jsonrpc/test_jsonrpc_check_and_call_power_off_missing_target.c
@@ -4,6 +4,7 @@
 #include "mock_log.h"
 #define MOCKED_LGTD_PROTO_POWER_OFF
 #include "mock_proto.h"
+#include "mock_wire_proto.h"
 
 #include "test_jsonrpc_utils.h"
 
diff --git a/tests/core/jsonrpc/test_jsonrpc_check_and_call_power_on.c b/tests/core/jsonrpc/test_jsonrpc_check_and_call_power_on.c
--- a/tests/core/jsonrpc/test_jsonrpc_check_and_call_power_on.c
+++ b/tests/core/jsonrpc/test_jsonrpc_check_and_call_power_on.c
@@ -4,6 +4,7 @@
 #include "mock_log.h"
 #define MOCKED_LGTD_PROTO_POWER_ON
 #include "mock_proto.h"
+#include "mock_wire_proto.h"
 
 #include "test_jsonrpc_utils.h"
 
diff --git a/tests/core/jsonrpc/test_jsonrpc_check_and_call_power_on_missing_target.c b/tests/core/jsonrpc/test_jsonrpc_check_and_call_power_on_missing_target.c
--- a/tests/core/jsonrpc/test_jsonrpc_check_and_call_power_on_missing_target.c
+++ b/tests/core/jsonrpc/test_jsonrpc_check_and_call_power_on_missing_target.c
@@ -4,6 +4,7 @@
 #include "mock_log.h"
 #define MOCKED_LGTD_PROTO_POWER_ON
 #include "mock_proto.h"
+#include "mock_wire_proto.h"
 
 #include "test_jsonrpc_utils.h"
 
diff --git a/tests/core/jsonrpc/test_jsonrpc_check_and_call_power_toggle.c b/tests/core/jsonrpc/test_jsonrpc_check_and_call_power_toggle.c
--- a/tests/core/jsonrpc/test_jsonrpc_check_and_call_power_toggle.c
+++ b/tests/core/jsonrpc/test_jsonrpc_check_and_call_power_toggle.c
@@ -4,6 +4,7 @@
 #include "mock_log.h"
 #define MOCKED_LGTD_PROTO_POWER_TOGGLE
 #include "mock_proto.h"
+#include "mock_wire_proto.h"
 
 #include "test_jsonrpc_utils.h"
 
diff --git a/tests/core/jsonrpc/test_jsonrpc_check_and_call_set_label.c b/tests/core/jsonrpc/test_jsonrpc_check_and_call_set_label.c
--- a/tests/core/jsonrpc/test_jsonrpc_check_and_call_set_label.c
+++ b/tests/core/jsonrpc/test_jsonrpc_check_and_call_set_label.c
@@ -4,6 +4,7 @@
 #include "mock_log.h"
 #define MOCKED_LGTD_PROTO_SET_LABEL
 #include "mock_proto.h"
+#include "mock_wire_proto.h"
 #include "mock_gateway.h"
 
 #include "test_jsonrpc_utils.h"
diff --git a/tests/core/jsonrpc/test_jsonrpc_check_and_call_set_light_from_hsbk.c b/tests/core/jsonrpc/test_jsonrpc_check_and_call_set_light_from_hsbk.c
--- a/tests/core/jsonrpc/test_jsonrpc_check_and_call_set_light_from_hsbk.c
+++ b/tests/core/jsonrpc/test_jsonrpc_check_and_call_set_light_from_hsbk.c
@@ -4,6 +4,7 @@
 #include "mock_log.h"
 #define MOCKED_LGTD_PROTO_SET_LIGHT_FROM_HSBK
 #include "mock_proto.h"
+#include "mock_wire_proto.h"
 
 #include "test_jsonrpc_utils.h"
 
diff --git a/tests/core/jsonrpc/test_jsonrpc_check_and_call_set_light_from_hsbk_from_array.c b/tests/core/jsonrpc/test_jsonrpc_check_and_call_set_light_from_hsbk_from_array.c
--- a/tests/core/jsonrpc/test_jsonrpc_check_and_call_set_light_from_hsbk_from_array.c
+++ b/tests/core/jsonrpc/test_jsonrpc_check_and_call_set_light_from_hsbk_from_array.c
@@ -4,6 +4,7 @@
 #include "mock_log.h"
 #define MOCKED_LGTD_PROTO_SET_LIGHT_FROM_HSBK
 #include "mock_proto.h"
+#include "mock_wire_proto.h"
 
 #include "test_jsonrpc_utils.h"
 
diff --git a/tests/core/jsonrpc/test_jsonrpc_check_and_call_set_light_from_hsbk_invalid_params.c b/tests/core/jsonrpc/test_jsonrpc_check_and_call_set_light_from_hsbk_invalid_params.c
--- a/tests/core/jsonrpc/test_jsonrpc_check_and_call_set_light_from_hsbk_invalid_params.c
+++ b/tests/core/jsonrpc/test_jsonrpc_check_and_call_set_light_from_hsbk_invalid_params.c
@@ -4,6 +4,7 @@
 #include "mock_log.h"
 #define MOCKED_LGTD_PROTO_SET_LIGHT_FROM_HSBK
 #include "mock_proto.h"
+#include "mock_wire_proto.h"
 
 #include "test_jsonrpc_utils.h"
 
diff --git a/tests/core/jsonrpc/test_jsonrpc_check_and_call_set_waveform.c b/tests/core/jsonrpc/test_jsonrpc_check_and_call_set_waveform.c
--- a/tests/core/jsonrpc/test_jsonrpc_check_and_call_set_waveform.c
+++ b/tests/core/jsonrpc/test_jsonrpc_check_and_call_set_waveform.c
@@ -4,9 +4,25 @@
 #include "mock_log.h"
 #define MOCKED_LGTD_PROTO_SET_WAVEFORM
 #include "mock_proto.h"
+#define MOCKED_LGTD_LIFX_WIRE_WAVEFORM_STRING_ID_TO_TYPE
+#include "mock_wire_proto.h"
 
 #include "test_jsonrpc_utils.h"
 
+enum lgtd_lifx_waveform_type
+lgtd_lifx_wire_waveform_string_id_to_type(const char *s, int len)
+{
+    if (len != 3) {
+        errx(1, "err = %d (expected 3)", len);
+    }
+
+    if (strncmp(s, "SAW", 3)) {
+        errx(1, "s = %.3s (expected SAW)", s);
+    }
+
+    return LGTD_LIFX_WAVEFORM_SAW;
+}
+
 static bool set_waveform_called = false;
 
 void
diff --git a/tests/core/jsonrpc/test_jsonrpc_check_and_call_set_waveform_invalid_params.c b/tests/core/jsonrpc/test_jsonrpc_check_and_call_set_waveform_invalid_params.c
--- a/tests/core/jsonrpc/test_jsonrpc_check_and_call_set_waveform_invalid_params.c
+++ b/tests/core/jsonrpc/test_jsonrpc_check_and_call_set_waveform_invalid_params.c
@@ -4,11 +4,20 @@
 #include "mock_log.h"
 #define MOCKED_LGTD_PROTO_SET_WAVEFORM
 #include "mock_proto.h"
+#define MOCKED_LGTD_LIFX_WIRE_WAVEFORM_STRING_ID_TO_TYPE
+#include "mock_wire_proto.h"
 
 #include "test_jsonrpc_utils.h"
 
 static bool set_waveform_called = false;
 
+enum lgtd_lifx_waveform_type
+lgtd_lifx_wire_waveform_string_id_to_type(const char *s, int len)
+{
+    return len == 3 && !strncmp(s, "SAW", 3) ?
+        LGTD_LIFX_WAVEFORM_SAW : LGTD_LIFX_WAVEFORM_INVALID;
+}
+
 void
 lgtd_proto_set_waveform(struct lgtd_client *client,
                         const struct lgtd_proto_target_list *targets,
diff --git a/tests/core/jsonrpc/test_jsonrpc_check_and_call_tag.c b/tests/core/jsonrpc/test_jsonrpc_check_and_call_tag.c
--- a/tests/core/jsonrpc/test_jsonrpc_check_and_call_tag.c
+++ b/tests/core/jsonrpc/test_jsonrpc_check_and_call_tag.c
@@ -4,6 +4,7 @@
 #include "mock_log.h"
 #define MOCKED_LGTD_PROTO_TAG
 #include "mock_proto.h"
+#include "mock_wire_proto.h"
 #include "mock_gateway.h"
 
 #include "test_jsonrpc_utils.h"
diff --git a/tests/core/jsonrpc/test_jsonrpc_check_and_call_tag_missing_params.c b/tests/core/jsonrpc/test_jsonrpc_check_and_call_tag_missing_params.c
--- a/tests/core/jsonrpc/test_jsonrpc_check_and_call_tag_missing_params.c
+++ b/tests/core/jsonrpc/test_jsonrpc_check_and_call_tag_missing_params.c
@@ -4,6 +4,7 @@
 #include "mock_log.h"
 #define MOCKED_LGTD_PROTO_TAG
 #include "mock_proto.h"
+#include "mock_wire_proto.h"
 #include "mock_gateway.h"
 
 #include "test_jsonrpc_utils.h"
diff --git a/tests/core/jsonrpc/test_jsonrpc_check_and_call_untag.c b/tests/core/jsonrpc/test_jsonrpc_check_and_call_untag.c
--- a/tests/core/jsonrpc/test_jsonrpc_check_and_call_untag.c
+++ b/tests/core/jsonrpc/test_jsonrpc_check_and_call_untag.c
@@ -4,6 +4,7 @@
 #include "mock_log.h"
 #define MOCKED_LGTD_PROTO_UNTAG
 #include "mock_proto.h"
+#include "mock_wire_proto.h"
 #include "mock_gateway.h"
 
 #include "test_jsonrpc_utils.h"
diff --git a/tests/core/jsonrpc/test_jsonrpc_check_and_call_untag_invalid_params.c b/tests/core/jsonrpc/test_jsonrpc_check_and_call_untag_invalid_params.c
--- a/tests/core/jsonrpc/test_jsonrpc_check_and_call_untag_invalid_params.c
+++ b/tests/core/jsonrpc/test_jsonrpc_check_and_call_untag_invalid_params.c
@@ -4,6 +4,7 @@
 #include "mock_log.h"
 #define MOCKED_LGTD_PROTO_UNTAG
 #include "mock_proto.h"
+#include "mock_wire_proto.h"
 #include "mock_gateway.h"
 
 #include "test_jsonrpc_utils.h"
diff --git a/tests/core/jsonrpc/test_jsonrpc_consume_object_or_array.c b/tests/core/jsonrpc/test_jsonrpc_consume_object_or_array.c
--- a/tests/core/jsonrpc/test_jsonrpc_consume_object_or_array.c
+++ b/tests/core/jsonrpc/test_jsonrpc_consume_object_or_array.c
@@ -3,6 +3,7 @@
 #include "mock_client_buf.h"
 #include "mock_log.h"
 #include "mock_proto.h"
+#include "mock_wire_proto.h"
 #include "test_jsonrpc_utils.h"
 
 int
diff --git a/tests/core/jsonrpc/test_jsonrpc_dispatch_one_no_params.c b/tests/core/jsonrpc/test_jsonrpc_dispatch_one_no_params.c
--- a/tests/core/jsonrpc/test_jsonrpc_dispatch_one_no_params.c
+++ b/tests/core/jsonrpc/test_jsonrpc_dispatch_one_no_params.c
@@ -4,6 +4,7 @@
 #include "mock_log.h"
 #define MOCKED_LGTD_PROTO_POWER_ON
 #include "mock_proto.h"
+#include "mock_wire_proto.h"
 
 #include "test_jsonrpc_utils.h"
 
diff --git a/tests/core/jsonrpc/test_jsonrpc_extract_request_no_params.c b/tests/core/jsonrpc/test_jsonrpc_extract_request_no_params.c
--- a/tests/core/jsonrpc/test_jsonrpc_extract_request_no_params.c
+++ b/tests/core/jsonrpc/test_jsonrpc_extract_request_no_params.c
@@ -3,6 +3,7 @@
 #include "mock_client_buf.h"
 #include "mock_log.h"
 #include "mock_proto.h"
+#include "mock_wire_proto.h"
 #include "test_jsonrpc_utils.h"
 
 int
diff --git a/tests/core/jsonrpc/test_jsonrpc_extract_request_notification_no_params.c b/tests/core/jsonrpc/test_jsonrpc_extract_request_notification_no_params.c
--- a/tests/core/jsonrpc/test_jsonrpc_extract_request_notification_no_params.c
+++ b/tests/core/jsonrpc/test_jsonrpc_extract_request_notification_no_params.c
@@ -3,6 +3,7 @@
 #include "mock_client_buf.h"
 #include "mock_log.h"
 #include "mock_proto.h"
+#include "mock_wire_proto.h"
 #include "test_jsonrpc_utils.h"
 
 int
diff --git a/tests/core/jsonrpc/test_jsonrpc_extract_request_params_array.c b/tests/core/jsonrpc/test_jsonrpc_extract_request_params_array.c
--- a/tests/core/jsonrpc/test_jsonrpc_extract_request_params_array.c
+++ b/tests/core/jsonrpc/test_jsonrpc_extract_request_params_array.c
@@ -3,6 +3,7 @@
 #include "mock_client_buf.h"
 #include "mock_log.h"
 #include "mock_proto.h"
+#include "mock_wire_proto.h"
 #include "test_jsonrpc_utils.h"
 
 int
diff --git a/tests/core/jsonrpc/test_jsonrpc_extract_request_params_obj.c b/tests/core/jsonrpc/test_jsonrpc_extract_request_params_obj.c
--- a/tests/core/jsonrpc/test_jsonrpc_extract_request_params_obj.c
+++ b/tests/core/jsonrpc/test_jsonrpc_extract_request_params_obj.c
@@ -3,6 +3,7 @@
 #include "mock_client_buf.h"
 #include "mock_log.h"
 #include "mock_proto.h"
+#include "mock_wire_proto.h"
 #include "test_jsonrpc_utils.h"
 
 int
diff --git a/tests/core/jsonrpc/test_jsonrpc_extract_request_valid_notification.c b/tests/core/jsonrpc/test_jsonrpc_extract_request_valid_notification.c
--- a/tests/core/jsonrpc/test_jsonrpc_extract_request_valid_notification.c
+++ b/tests/core/jsonrpc/test_jsonrpc_extract_request_valid_notification.c
@@ -3,6 +3,7 @@
 #include "mock_client_buf.h"
 #include "mock_log.h"
 #include "mock_proto.h"
+#include "mock_wire_proto.h"
 #include "test_jsonrpc_utils.h"
 
 int
diff --git a/tests/core/jsonrpc/test_jsonrpc_extract_values_from_schema_and_array_honors_objsize.c b/tests/core/jsonrpc/test_jsonrpc_extract_values_from_schema_and_array_honors_objsize.c
--- a/tests/core/jsonrpc/test_jsonrpc_extract_values_from_schema_and_array_honors_objsize.c
+++ b/tests/core/jsonrpc/test_jsonrpc_extract_values_from_schema_and_array_honors_objsize.c
@@ -5,6 +5,7 @@
 #include "mock_client_buf.h"
 #include "mock_log.h"
 #include "mock_proto.h"
+#include "mock_wire_proto.h"
 #include "test_jsonrpc_utils.h"
 
 int
diff --git a/tests/core/jsonrpc/test_jsonrpc_send_error.c b/tests/core/jsonrpc/test_jsonrpc_send_error.c
--- a/tests/core/jsonrpc/test_jsonrpc_send_error.c
+++ b/tests/core/jsonrpc/test_jsonrpc_send_error.c
@@ -3,6 +3,7 @@
 #include "mock_client_buf.h"
 #include "mock_log.h"
 #include "mock_proto.h"
+#include "mock_wire_proto.h"
 #include "test_jsonrpc_utils.h"
 
 int
diff --git a/tests/core/jsonrpc/test_jsonrpc_send_response.c b/tests/core/jsonrpc/test_jsonrpc_send_response.c
--- a/tests/core/jsonrpc/test_jsonrpc_send_response.c
+++ b/tests/core/jsonrpc/test_jsonrpc_send_response.c
@@ -3,6 +3,7 @@
 #include "mock_client_buf.h"
 #include "mock_log.h"
 #include "mock_proto.h"
+#include "mock_wire_proto.h"
 #include "test_jsonrpc_utils.h"
 
 int
diff --git a/tests/core/jsonrpc/test_jsonrpc_type_float_between_0_and_1_invalid.c b/tests/core/jsonrpc/test_jsonrpc_type_float_between_0_and_1_invalid.c
--- a/tests/core/jsonrpc/test_jsonrpc_type_float_between_0_and_1_invalid.c
+++ b/tests/core/jsonrpc/test_jsonrpc_type_float_between_0_and_1_invalid.c
@@ -3,6 +3,7 @@
 #include "mock_client_buf.h"
 #include "mock_log.h"
 #include "mock_proto.h"
+#include "mock_wire_proto.h"
 #include "test_jsonrpc_utils.h"
 
 static void
diff --git a/tests/core/jsonrpc/test_jsonrpc_type_float_between_0_and_1_valid.c b/tests/core/jsonrpc/test_jsonrpc_type_float_between_0_and_1_valid.c
--- a/tests/core/jsonrpc/test_jsonrpc_type_float_between_0_and_1_valid.c
+++ b/tests/core/jsonrpc/test_jsonrpc_type_float_between_0_and_1_valid.c
@@ -3,6 +3,7 @@
 #include "mock_client_buf.h"
 #include "mock_log.h"
 #include "mock_proto.h"
+#include "mock_wire_proto.h"
 #include "test_jsonrpc_utils.h"
 
 static void
diff --git a/tests/core/jsonrpc/test_jsonrpc_type_float_between_0_and_360_invalid.c b/tests/core/jsonrpc/test_jsonrpc_type_float_between_0_and_360_invalid.c
--- a/tests/core/jsonrpc/test_jsonrpc_type_float_between_0_and_360_invalid.c
+++ b/tests/core/jsonrpc/test_jsonrpc_type_float_between_0_and_360_invalid.c
@@ -3,6 +3,7 @@
 #include "mock_client_buf.h"
 #include "mock_log.h"
 #include "mock_proto.h"
+#include "mock_wire_proto.h"
 #include "test_jsonrpc_utils.h"
 
 static void
diff --git a/tests/core/jsonrpc/test_jsonrpc_type_float_between_0_and_360_valid.c b/tests/core/jsonrpc/test_jsonrpc_type_float_between_0_and_360_valid.c
--- a/tests/core/jsonrpc/test_jsonrpc_type_float_between_0_and_360_valid.c
+++ b/tests/core/jsonrpc/test_jsonrpc_type_float_between_0_and_360_valid.c
@@ -3,6 +3,7 @@
 #include "mock_client_buf.h"
 #include "mock_log.h"
 #include "mock_proto.h"
+#include "mock_wire_proto.h"
 #include "test_jsonrpc_utils.h"
 
 static void
diff --git a/tests/core/jsonrpc/test_jsonrpc_type_integer.c b/tests/core/jsonrpc/test_jsonrpc_type_integer.c
--- a/tests/core/jsonrpc/test_jsonrpc_type_integer.c
+++ b/tests/core/jsonrpc/test_jsonrpc_type_integer.c
@@ -3,6 +3,7 @@
 #include "mock_client_buf.h"
 #include "mock_log.h"
 #include "mock_proto.h"
+#include "mock_wire_proto.h"
 #include "test_jsonrpc_utils.h"
 
 int
diff --git a/tests/core/jsonrpc/test_jsonrpc_type_integer_invalid_characters.c b/tests/core/jsonrpc/test_jsonrpc_type_integer_invalid_characters.c
--- a/tests/core/jsonrpc/test_jsonrpc_type_integer_invalid_characters.c
+++ b/tests/core/jsonrpc/test_jsonrpc_type_integer_invalid_characters.c
@@ -3,6 +3,7 @@
 #include "mock_client_buf.h"
 #include "mock_log.h"
 #include "mock_proto.h"
+#include "mock_wire_proto.h"
 #include "test_jsonrpc_utils.h"
 
 int
diff --git a/tests/core/jsonrpc/test_jsonrpc_type_integer_too_big.c b/tests/core/jsonrpc/test_jsonrpc_type_integer_too_big.c
--- a/tests/core/jsonrpc/test_jsonrpc_type_integer_too_big.c
+++ b/tests/core/jsonrpc/test_jsonrpc_type_integer_too_big.c
@@ -3,6 +3,7 @@
 #include "mock_client_buf.h"
 #include "mock_log.h"
 #include "mock_proto.h"
+#include "mock_wire_proto.h"
 #include "test_jsonrpc_utils.h"
 
 int
diff --git a/tests/core/jsonrpc/test_jsonrpc_type_integer_too_small.c b/tests/core/jsonrpc/test_jsonrpc_type_integer_too_small.c
--- a/tests/core/jsonrpc/test_jsonrpc_type_integer_too_small.c
+++ b/tests/core/jsonrpc/test_jsonrpc_type_integer_too_small.c
@@ -3,6 +3,7 @@
 #include "mock_client_buf.h"
 #include "mock_log.h"
 #include "mock_proto.h"
+#include "mock_wire_proto.h"
 #include "test_jsonrpc_utils.h"
 
 int
diff --git a/tests/core/jsonrpc/test_jsonrpc_uint16_range_to_float_string.c b/tests/core/jsonrpc/test_jsonrpc_uint16_range_to_float_string.c
--- a/tests/core/jsonrpc/test_jsonrpc_uint16_range_to_float_string.c
+++ b/tests/core/jsonrpc/test_jsonrpc_uint16_range_to_float_string.c
@@ -5,6 +5,7 @@
 #include "mock_client_buf.h"
 #include "mock_log.h"
 #include "mock_proto.h"
+#include "mock_wire_proto.h"
 #include "test_jsonrpc_utils.h"
 
 int
diff --git a/tests/core/mock_daemon.h b/tests/core/mock_daemon.h
--- a/tests/core/mock_daemon.h
+++ b/tests/core/mock_daemon.h
@@ -15,3 +15,11 @@
     return true;
 }
 #endif
+
+#ifndef MOCKED_DAEMON_RANDUINT32
+uint32_t
+lgtd_daemon_randuint32(void)
+{
+    return 0x72616e64;
+}
+#endif
diff --git a/tests/core/pipe/CMakeLists.txt b/tests/core/pipe/CMakeLists.txt
--- a/tests/core/pipe/CMakeLists.txt
+++ b/tests/core/pipe/CMakeLists.txt
@@ -10,7 +10,6 @@
     ${LIGHTSD_SOURCE_DIR}/core/utils.c
     ${LIGHTSD_SOURCE_DIR}/lifx/bulb.c
     ${LIGHTSD_SOURCE_DIR}/lifx/tagging.c
-    ${LIGHTSD_SOURCE_DIR}/lifx/wire_proto.c
     ${CMAKE_CURRENT_SOURCE_DIR}/../tests_shims.c
     ${CMAKE_CURRENT_SOURCE_DIR}/../tests_utils.c
 )
diff --git a/tests/core/proto/CMakeLists.txt b/tests/core/proto/CMakeLists.txt
--- a/tests/core/proto/CMakeLists.txt
+++ b/tests/core/proto/CMakeLists.txt
@@ -10,7 +10,6 @@
     ${LIGHTSD_SOURCE_DIR}/core/utils.c
     ${LIGHTSD_SOURCE_DIR}/lifx/bulb.c
     ${LIGHTSD_SOURCE_DIR}/lifx/tagging.c
-    ${LIGHTSD_SOURCE_DIR}/lifx/wire_proto.c
     ${CMAKE_CURRENT_SOURCE_DIR}/../tests_shims.c
     ${CMAKE_CURRENT_SOURCE_DIR}/../tests_utils.c
 )
diff --git a/tests/core/router/test_router_send_to_broadcast.c b/tests/core/router/test_router_send_to_broadcast.c
--- a/tests/core/router/test_router_send_to_broadcast.c
+++ b/tests/core/router/test_router_send_to_broadcast.c
@@ -10,7 +10,7 @@
 int
 main(void)
 {
-    lgtd_lifx_wire_load_packet_info_map();
+    lgtd_lifx_wire_setup();
 
     lgtd_tests_insert_mock_gateway(2);
     lgtd_tests_insert_mock_gateway(1);
diff --git a/tests/core/router/test_router_send_to_device.c b/tests/core/router/test_router_send_to_device.c
--- a/tests/core/router/test_router_send_to_device.c
+++ b/tests/core/router/test_router_send_to_device.c
@@ -9,7 +9,7 @@
 int
 main(void)
 {
-    lgtd_lifx_wire_load_packet_info_map();
+    lgtd_lifx_wire_setup();
 
     struct lgtd_lifx_gateway *gw_1 = lgtd_tests_insert_mock_gateway(1);
     struct lgtd_lifx_bulb *bulb_1 = lgtd_tests_insert_mock_bulb(gw_1, 1);
diff --git a/tests/core/router/test_router_send_to_invalid_targets.c b/tests/core/router/test_router_send_to_invalid_targets.c
--- a/tests/core/router/test_router_send_to_invalid_targets.c
+++ b/tests/core/router/test_router_send_to_invalid_targets.c
@@ -33,7 +33,7 @@
 int
 main(void)
 {
-    lgtd_lifx_wire_load_packet_info_map();
+    lgtd_lifx_wire_setup();
 
     struct lgtd_lifx_gateway *gw_1 = lgtd_tests_insert_mock_gateway(1);
     lgtd_tests_insert_mock_bulb(gw_1, 1);
diff --git a/tests/core/router/test_router_send_to_label.c b/tests/core/router/test_router_send_to_label.c
--- a/tests/core/router/test_router_send_to_label.c
+++ b/tests/core/router/test_router_send_to_label.c
@@ -9,7 +9,7 @@
 int
 main(void)
 {
-    lgtd_lifx_wire_load_packet_info_map();
+    lgtd_lifx_wire_setup();
 
     struct lgtd_lifx_gateway *gw_1 = lgtd_tests_insert_mock_gateway(1);
     struct lgtd_lifx_bulb *bulb_1 = lgtd_tests_insert_mock_bulb(gw_1, 1);
diff --git a/tests/core/router/test_router_send_to_tag.c b/tests/core/router/test_router_send_to_tag.c
--- a/tests/core/router/test_router_send_to_tag.c
+++ b/tests/core/router/test_router_send_to_tag.c
@@ -9,7 +9,7 @@
 int
 main(void)
 {
-    lgtd_lifx_wire_load_packet_info_map();
+    lgtd_lifx_wire_setup();
 
     struct lgtd_lifx_gateway *gw_1 = lgtd_tests_insert_mock_gateway(1);
     struct lgtd_lifx_gateway *gw_2 = lgtd_tests_insert_mock_gateway(2);
diff --git a/tests/core/router/test_router_targets_to_devices.c b/tests/core/router/test_router_targets_to_devices.c
--- a/tests/core/router/test_router_targets_to_devices.c
+++ b/tests/core/router/test_router_targets_to_devices.c
@@ -43,7 +43,7 @@
 int
 main(void)
 {
-    lgtd_lifx_wire_load_packet_info_map();
+    lgtd_lifx_wire_setup();
 
     struct lgtd_lifx_gateway *gw_1 = lgtd_tests_insert_mock_gateway(1);
     struct lgtd_lifx_gateway *gw_2 = lgtd_tests_insert_mock_gateway(2);
diff --git a/tests/core/tests_shims.c b/tests/core/tests_shims.c
--- a/tests/core/tests_shims.c
+++ b/tests/core/tests_shims.c
@@ -29,6 +29,17 @@
 
 struct event_base *lgtd_ev_base = MOCK_LGTD_EV_BASE;
 
+const int LGTD_LIFX_DEBRUIJN_SEQUENCE[64] = {
+    0, 47,  1, 56, 48, 27,  2, 60,
+   57, 49, 41, 37, 28, 16,  3, 61,
+   54, 58, 35, 52, 50, 42, 21, 44,
+   38, 32, 29, 23, 17, 11,  4, 62,
+   46, 55, 26, 59, 40, 36, 15, 53,
+   34, 51, 20, 43, 31, 22, 10, 45,
+   25, 39, 14, 33, 19, 30,  9, 24,
+   13, 18,  8, 12,  7,  6,  5, 63
+};
+
 void
 lgtd_cleanup(void)
 {
diff --git a/tests/lifx/gateway/test_gateway_allocate_tag_id.c b/tests/lifx/gateway/test_gateway_allocate_tag_id.c
--- a/tests/lifx/gateway/test_gateway_allocate_tag_id.c
+++ b/tests/lifx/gateway/test_gateway_allocate_tag_id.c
@@ -42,7 +42,7 @@
 int
 main(void)
 {
-    lgtd_lifx_wire_load_packet_info_map();
+    lgtd_lifx_wire_setup();
 
     struct lgtd_lifx_gateway gw;
     memset(&gw, 0, sizeof(gw));
diff --git a/tests/lifx/gateway/test_gateway_allocate_tag_id_from_lifx_network.c b/tests/lifx/gateway/test_gateway_allocate_tag_id_from_lifx_network.c
--- a/tests/lifx/gateway/test_gateway_allocate_tag_id_from_lifx_network.c
+++ b/tests/lifx/gateway/test_gateway_allocate_tag_id_from_lifx_network.c
@@ -43,7 +43,7 @@
 int
 main(void)
 {
-    lgtd_lifx_wire_load_packet_info_map();
+    lgtd_lifx_wire_setup();
 
     struct lgtd_lifx_gateway gw;
     memset(&gw, 0, sizeof(gw));
diff --git a/tests/lifx/gateway/test_gateway_allocate_tag_id_no_tag_id_left.c b/tests/lifx/gateway/test_gateway_allocate_tag_id_no_tag_id_left.c
--- a/tests/lifx/gateway/test_gateway_allocate_tag_id_no_tag_id_left.c
+++ b/tests/lifx/gateway/test_gateway_allocate_tag_id_no_tag_id_left.c
@@ -43,7 +43,7 @@
 int
 main(void)
 {
-    lgtd_lifx_wire_load_packet_info_map();
+    lgtd_lifx_wire_setup();
 
     struct lgtd_lifx_gateway gw;
     memset(&gw, 0, sizeof(gw));
diff --git a/tests/lifx/gateway/test_gateway_deallocate_tag_id_from_lifx_network.c b/tests/lifx/gateway/test_gateway_deallocate_tag_id_from_lifx_network.c
--- a/tests/lifx/gateway/test_gateway_deallocate_tag_id_from_lifx_network.c
+++ b/tests/lifx/gateway/test_gateway_deallocate_tag_id_from_lifx_network.c
@@ -25,7 +25,7 @@
 int
 main(void)
 {
-    lgtd_lifx_wire_load_packet_info_map();
+    lgtd_lifx_wire_setup();
 
     struct lgtd_lifx_gateway gw;
     memset(&gw, 0, sizeof(gw));
diff --git a/tests/lifx/gateway/test_gateway_enqueue_packet.c b/tests/lifx/gateway/test_gateway_enqueue_packet.c
--- a/tests/lifx/gateway/test_gateway_enqueue_packet.c
+++ b/tests/lifx/gateway/test_gateway_enqueue_packet.c
@@ -7,7 +7,7 @@
 int
 main(void)
 {
-    lgtd_lifx_wire_load_packet_info_map();
+    lgtd_lifx_wire_setup();
 
     struct lgtd_lifx_gateway gw;
     memset(&gw, 0, sizeof(gw));
diff --git a/tests/lifx/gateway/test_gateway_enqueue_packet_ring_full.c b/tests/lifx/gateway/test_gateway_enqueue_packet_ring_full.c
--- a/tests/lifx/gateway/test_gateway_enqueue_packet_ring_full.c
+++ b/tests/lifx/gateway/test_gateway_enqueue_packet_ring_full.c
@@ -7,7 +7,7 @@
 int
 main(void)
 {
-    lgtd_lifx_wire_load_packet_info_map();
+    lgtd_lifx_wire_setup();
 
     struct lgtd_lifx_gateway gw;
     memset(&gw, 0, sizeof(gw));
diff --git a/tests/lifx/gateway/test_gateway_enqueue_packet_ring_wraparound.c b/tests/lifx/gateway/test_gateway_enqueue_packet_ring_wraparound.c
--- a/tests/lifx/gateway/test_gateway_enqueue_packet_ring_wraparound.c
+++ b/tests/lifx/gateway/test_gateway_enqueue_packet_ring_wraparound.c
@@ -7,7 +7,7 @@
 int
 main(void)
 {
-    lgtd_lifx_wire_load_packet_info_map();
+    lgtd_lifx_wire_setup();
 
     struct lgtd_lifx_gateway gw;
     memset(&gw, 0, sizeof(gw));
diff --git a/tests/lifx/gateway/test_gateway_handle_ambient_light.c b/tests/lifx/gateway/test_gateway_handle_ambient_light.c
--- a/tests/lifx/gateway/test_gateway_handle_ambient_light.c
+++ b/tests/lifx/gateway/test_gateway_handle_ambient_light.c
@@ -10,7 +10,7 @@
 int
 main(void)
 {
-    lgtd_lifx_wire_load_packet_info_map();
+    lgtd_lifx_wire_setup();
 
     struct lgtd_lifx_gateway gw;
     memset(&gw, 0, sizeof(gw));
diff --git a/tests/lifx/gateway/test_gateway_handle_bulb_label.c b/tests/lifx/gateway/test_gateway_handle_bulb_label.c
--- a/tests/lifx/gateway/test_gateway_handle_bulb_label.c
+++ b/tests/lifx/gateway/test_gateway_handle_bulb_label.c
@@ -10,7 +10,7 @@
 int
 main(void)
 {
-    lgtd_lifx_wire_load_packet_info_map();
+    lgtd_lifx_wire_setup();
 
     struct lgtd_lifx_gateway gw = { .last_pkt_at = 42 };
 
diff --git a/tests/lifx/gateway/test_gateway_handle_ip_firmware_info.c b/tests/lifx/gateway/test_gateway_handle_ip_firmware_info.c
--- a/tests/lifx/gateway/test_gateway_handle_ip_firmware_info.c
+++ b/tests/lifx/gateway/test_gateway_handle_ip_firmware_info.c
@@ -10,7 +10,7 @@
 int
 main(void)
 {
-    lgtd_lifx_wire_load_packet_info_map();
+    lgtd_lifx_wire_setup();
 
     struct lgtd_lifx_gateway gw = { .last_pkt_at = 42 };
 
diff --git a/tests/lifx/gateway/test_gateway_handle_ip_state.c b/tests/lifx/gateway/test_gateway_handle_ip_state.c
--- a/tests/lifx/gateway/test_gateway_handle_ip_state.c
+++ b/tests/lifx/gateway/test_gateway_handle_ip_state.c
@@ -10,7 +10,7 @@
 int
 main(void)
 {
-    lgtd_lifx_wire_load_packet_info_map();
+    lgtd_lifx_wire_setup();
 
     struct lgtd_lifx_gateway gw = { .last_pkt_at = 42 };
 
diff --git a/tests/lifx/gateway/test_gateway_handle_product_info.c b/tests/lifx/gateway/test_gateway_handle_product_info.c
--- a/tests/lifx/gateway/test_gateway_handle_product_info.c
+++ b/tests/lifx/gateway/test_gateway_handle_product_info.c
@@ -10,7 +10,7 @@
 int
 main(void)
 {
-    lgtd_lifx_wire_load_packet_info_map();
+    lgtd_lifx_wire_setup();
 
     struct lgtd_lifx_gateway gw = { .last_pkt_at = 42 };
 
diff --git a/tests/lifx/gateway/test_gateway_handle_runtime_info.c b/tests/lifx/gateway/test_gateway_handle_runtime_info.c
--- a/tests/lifx/gateway/test_gateway_handle_runtime_info.c
+++ b/tests/lifx/gateway/test_gateway_handle_runtime_info.c
@@ -10,7 +10,7 @@
 int
 main(void)
 {
-    lgtd_lifx_wire_load_packet_info_map();
+    lgtd_lifx_wire_setup();
 
     struct lgtd_lifx_gateway gw = { .last_pkt_at = 42 };
 
diff --git a/tests/lifx/gateway/test_gateway_handle_tag_labels.c b/tests/lifx/gateway/test_gateway_handle_tag_labels.c
--- a/tests/lifx/gateway/test_gateway_handle_tag_labels.c
+++ b/tests/lifx/gateway/test_gateway_handle_tag_labels.c
@@ -9,7 +9,7 @@
 int
 main(void)
 {
-    lgtd_lifx_wire_load_packet_info_map();
+    lgtd_lifx_wire_setup();
 
     struct lgtd_lifx_gateway gw;
     memset(&gw, 0, sizeof(gw));
diff --git a/tests/lifx/gateway/test_gateway_handle_tags.c b/tests/lifx/gateway/test_gateway_handle_tags.c
--- a/tests/lifx/gateway/test_gateway_handle_tags.c
+++ b/tests/lifx/gateway/test_gateway_handle_tags.c
@@ -10,7 +10,7 @@
 int
 main(void)
 {
-    lgtd_lifx_wire_load_packet_info_map();
+    lgtd_lifx_wire_setup();
 
     struct lgtd_lifx_gateway gw;
     memset(&gw, 0, sizeof(gw));
diff --git a/tests/lifx/gateway/test_gateway_update_tag_refcounts.c b/tests/lifx/gateway/test_gateway_update_tag_refcounts.c
--- a/tests/lifx/gateway/test_gateway_update_tag_refcounts.c
+++ b/tests/lifx/gateway/test_gateway_update_tag_refcounts.c
@@ -7,7 +7,7 @@
 int
 main(void)
 {
-    lgtd_lifx_wire_load_packet_info_map();
+    lgtd_lifx_wire_setup();
 
     struct lgtd_lifx_gateway gw;
     memset(&gw, 0, sizeof(gw));
diff --git a/tests/lifx/gateway/test_gateway_write_callback.c b/tests/lifx/gateway/test_gateway_write_callback.c
--- a/tests/lifx/gateway/test_gateway_write_callback.c
+++ b/tests/lifx/gateway/test_gateway_write_callback.c
@@ -45,7 +45,7 @@
 int
 main(void)
 {
-    lgtd_lifx_wire_load_packet_info_map();
+    lgtd_lifx_wire_setup();
 
     struct lgtd_lifx_gateway gw;
     memset(&gw, 0, sizeof(gw));
diff --git a/tests/lifx/gateway/test_gateway_write_callback_clears_ring_full_flag.c b/tests/lifx/gateway/test_gateway_write_callback_clears_ring_full_flag.c
--- a/tests/lifx/gateway/test_gateway_write_callback_clears_ring_full_flag.c
+++ b/tests/lifx/gateway/test_gateway_write_callback_clears_ring_full_flag.c
@@ -45,7 +45,7 @@
 int
 main(void)
 {
-    lgtd_lifx_wire_load_packet_info_map();
+    lgtd_lifx_wire_setup();
 
     struct lgtd_lifx_gateway gw;
     memset(&gw, 0, sizeof(gw));
diff --git a/tests/lifx/gateway/test_gateway_write_callback_last_packet_on_ring.c b/tests/lifx/gateway/test_gateway_write_callback_last_packet_on_ring.c
--- a/tests/lifx/gateway/test_gateway_write_callback_last_packet_on_ring.c
+++ b/tests/lifx/gateway/test_gateway_write_callback_last_packet_on_ring.c
@@ -44,7 +44,7 @@
 int
 main(void)
 {
-    lgtd_lifx_wire_load_packet_info_map();
+    lgtd_lifx_wire_setup();
 
     struct lgtd_lifx_gateway gw;
     memset(&gw, 0, sizeof(gw));
diff --git a/tests/lifx/gateway/test_gateway_write_callback_partial_write.c b/tests/lifx/gateway/test_gateway_write_callback_partial_write.c
--- a/tests/lifx/gateway/test_gateway_write_callback_partial_write.c
+++ b/tests/lifx/gateway/test_gateway_write_callback_partial_write.c
@@ -52,7 +52,7 @@
 int
 main(void)
 {
-    lgtd_lifx_wire_load_packet_info_map();
+    lgtd_lifx_wire_setup();
 
     struct lgtd_lifx_gateway gw;
     memset(&gw, 0, sizeof(gw));
diff --git a/tests/lifx/gateway/test_gateway_write_callback_ring_wraparound.c b/tests/lifx/gateway/test_gateway_write_callback_ring_wraparound.c
--- a/tests/lifx/gateway/test_gateway_write_callback_ring_wraparound.c
+++ b/tests/lifx/gateway/test_gateway_write_callback_ring_wraparound.c
@@ -45,7 +45,7 @@
 int
 main(void)
 {
-    lgtd_lifx_wire_load_packet_info_map();
+    lgtd_lifx_wire_setup();
 
     struct lgtd_lifx_gateway gw;
     memset(&gw, 0, sizeof(gw));
diff --git a/tests/lifx/mock_wire_proto.h b/tests/lifx/mock_wire_proto.h
new file mode 100644
--- /dev/null
+++ b/tests/lifx/mock_wire_proto.h
@@ -0,0 +1,11 @@
+#pragma once
+
+#ifndef MOCKED_LGTD_LIFX_WIRE_WAVEFORM_STRING_ID_TO_TYPE
+enum lgtd_lifx_waveform_type
+lgtd_lifx_wire_waveform_string_id_to_type(const char *s, int len)
+{
+    (void)s;
+    (void)len;
+    return LGTD_LIFX_WAVEFORM_INVALID;
+}
+#endif
diff --git a/tests/lifx/tests_shims.c b/tests/lifx/tests_shims.c
--- a/tests/lifx/tests_shims.c
+++ b/tests/lifx/tests_shims.c
@@ -15,6 +15,17 @@
 
 struct event_base *lgtd_ev_base = NULL;
 
+const int LGTD_LIFX_DEBRUIJN_SEQUENCE[64] = {
+    0, 47,  1, 56, 48, 27,  2, 60,
+   57, 49, 41, 37, 28, 16,  3, 61,
+   54, 58, 35, 52, 50, 42, 21, 44,
+   38, 32, 29, 23, 17, 11,  4, 62,
+   46, 55, 26, 59, 40, 36, 15, 53,
+   34, 51, 20, 43, 31, 22, 10, 45,
+   25, 39, 14, 33, 19, 30,  9, 24,
+   13, 18,  8, 12,  7,  6,  5, 63
+};
+
 void
 lgtd_cleanup(void)
 {
