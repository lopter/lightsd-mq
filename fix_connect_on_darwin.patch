# HG changeset patch
# Parent 3a8e9a9d1e7f3e88c1dfd943b15be61769b7f356
Fix connect on Darwin

diff --git a/core/broadcast.c b/core/broadcast.c
--- a/core/broadcast.c
+++ b/core/broadcast.c
@@ -145,7 +145,7 @@
         }
         struct lifxd_gateway *gw = lifxd_gateway_get(&peer);
         if (!gw && read.hdr.packet_type == LIFXD_PAN_GATEWAY) {
-            gw = lifxd_gateway_open(&peer, read.hdr.site, received_at);
+            gw = lifxd_gateway_open(&peer, addrlen, read.hdr.site, received_at);
             if (!gw) {
                 lifxd_err(1, "can't allocate gateway");
             }
diff --git a/core/gateway.c b/core/gateway.c
--- a/core/gateway.c
+++ b/core/gateway.c
@@ -163,6 +163,7 @@
 
 struct lifxd_gateway *
 lifxd_gateway_open(const struct sockaddr_storage *peer,
+                   ev_socklen_t addrlen,
                    const uint8_t *site,
                    lifxd_time_mono_t received_at)
 {
@@ -179,7 +180,7 @@
         lifxd_warn("can't open a new socket");
         goto error_socket;
     }
-    if (connect(gw->socket, (const struct sockaddr *)peer, sizeof(*peer)) == -1
+    if (connect(gw->socket, (const struct sockaddr *)peer, addrlen) == -1
         || evutil_make_socket_nonblocking(gw->socket) == -1) {
         lifxd_warn("can't open a new socket");
         goto error_connect;
diff --git a/core/gateway.h b/core/gateway.h
--- a/core/gateway.h
+++ b/core/gateway.h
@@ -65,6 +65,7 @@
 
 struct lifxd_gateway *lifxd_gateway_get(const struct sockaddr_storage *);
 struct lifxd_gateway *lifxd_gateway_open(const struct sockaddr_storage *,
+                                         ev_socklen_t,
                                          const uint8_t *,
                                          lifxd_time_mono_t);
 
