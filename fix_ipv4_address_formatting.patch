# HG changeset patch
# Parent  118f1bcc0f067c493b1f5e112c02ac92fd922dc1
Fix IPv4 address formatting

diff --git a/core/lightsd.h b/core/lightsd.h
--- a/core/lightsd.h
+++ b/core/lightsd.h
@@ -28,6 +28,10 @@
     .tv_sec = (v) / 1000,           \
     .tv_usec = ((v) % 1000) * 1000  \
 }
+#define LGTD_SNPRINTF_APPEND(buf, i, bufsz, ...) do {       \
+    int n = snprintf(&(buf)[(i)], bufsz - i, __VA_ARGS__);  \
+    (i) = LGTD_MIN((i) + n, bufsz);                         \
+} while (0)
 
 enum lgtd_verbosity {
     LGTD_DEBUG = 0,
diff --git a/core/log.c b/core/log.c
--- a/core/log.c
+++ b/core/log.c
@@ -26,6 +26,7 @@
 #include <stdbool.h>
 #include <stdint.h>
 #include <stdio.h>
+#include <stdlib.h>
 #include <time.h>
 
 #if LGTD_HAVE_LIBBSD
@@ -100,12 +101,22 @@
     assert(buf);
     assert(buflen > 0);
 
+    const char *printed;
     if (peer->ss_family == AF_INET) {
         const struct sockaddr_in *in_peer = (const struct sockaddr_in *)peer;
-        inet_ntop(AF_INET, &in_peer->sin_addr, buf, buflen);
+        int i = 0;
+        LGTD_SNPRINTF_APPEND(buf, i, buflen, "::ffff:");
+        printed = inet_ntop(AF_INET, &in_peer->sin_addr, &buf[i], buflen - i);
     } else {
         const struct sockaddr_in6 *in6_peer = (const struct sockaddr_in6 *)peer;
-        inet_ntop(AF_INET6, &in6_peer->sin6_addr, buf, buflen);
+        printed = inet_ntop(AF_INET6, &in6_peer->sin6_addr, buf, buflen);
+    }
+    if (!printed) {
+        buf[0] = 0;
+        lgtd_warnx("not enough space to log an ip address");
+#ifndef NDEBUG
+        abort();
+#endif
     }
 }
 
