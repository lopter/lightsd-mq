# HG changeset patch
# Parent  89ba90d5bbd2696bb9089d9dc6b9ae29061a18ba
Fix build on GNU/Linux

diff --git a/CMakeLists.txt b/CMakeLists.txt
--- a/CMakeLists.txt
+++ b/CMakeLists.txt
@@ -24,7 +24,12 @@
 
 SET(CMAKE_C_FLAGS "-pipe -Wextra -Wall -Wstrict-prototypes -std=c99")
 
-ADD_DEFINITIONS("-D_POSIX_C_SOURCE=200809L" "-D_BSD_SOURCE=1")
+# Only relevant for the GNU libc:
+ADD_DEFINITIONS(
+    "-D_POSIX_C_SOURCE=200809L"
+    "-D_BSD_SOURCE=1"
+    "-D_DEFAULT_SOURCE=1"
+)
 
 IF (CMAKE_BUILD_TYPE MATCHES "DEBUG")
     ADD_DEFINITIONS("-DQUEUE_MACRO_DEBUG=1")
diff --git a/CMakeScripts/CompatTimeMonotonic.cmake b/CMakeScripts/CompatTimeMonotonic.cmake
--- a/CMakeScripts/CompatTimeMonotonic.cmake
+++ b/CMakeScripts/CompatTimeMonotonic.cmake
@@ -4,7 +4,7 @@
     SET(COMPAT_TIME_MONOTONIC_IMPL "${LIFXD_SOURCE_DIR}/compat/${CMAKE_SYSTEM_NAME}/time_monotonic.c")
     SET(COMPAT_TIME_MONOTONIC_H "${LIFXD_SOURCE_DIR}/compat/${CMAKE_SYSTEM_NAME}/time_monotonic.h")
     SET(GENERIC_TIME_MONOTONIC_IMPL "${LIFXD_SOURCE_DIR}/compat/generic/time_monotonic.c")
-    SET(GENERIC_TIME_MONOTONIC_IMPL "${LIFXD_SOURCE_DIR}/compat/generic/time_monotonic.h")
+    SET(GENERIC_TIME_MONOTONIC_H "${LIFXD_SOURCE_DIR}/compat/generic/time_monotonic.h")
 
     SET(CMAKE_REQUIRED_QUIET TRUE)
     MESSAGE(STATUS "Looking for clock_gettime")
@@ -13,11 +13,11 @@
 
     IF (HAVE_CLOCK_GETTIME)
         MESSAGE(STATUS "Looking for clock_gettime - found")
+        FILE(COPY "${GENERIC_TIME_MONOTONIC_H}" DESTINATION "${LIFXD_BINARY_DIR}/compat/")
         SET(
             TIME_MONOTONIC_IMPL "${GENERIC_TIME_MONOTONIC_IMPL}"
             CACHE INTERNAL "lifxd_time_monotonic (POSIX generic implementation)"
         )
-        FILE(COPY "${GENERIC_TIME_MONOTONIC_H}" "${LIFXD_BINARY_DIR}/compat/")
     ELSEIF (EXISTS "${COMPAT_TIME_MONOTONIC_IMPL}")
         MESSAGE(STATUS "Looking for clock_gettime - not found, using built-in compatibilty file")
         FILE(COPY "${COMPAT_TIME_MONOTONIC_H}" DESTINATION "${LIFXD_BINARY_DIR}/compat/")
diff --git a/CMakeScripts/FindEndian.cmake b/CMakeScripts/FindEndian.cmake
--- a/CMakeScripts/FindEndian.cmake
+++ b/CMakeScripts/FindEndian.cmake
@@ -2,6 +2,7 @@
 
 IF (NOT ENDIAN_H_PATH)
     SET(COMPAT_ENDIAN_H "${LIFXD_SOURCE_DIR}/compat/${CMAKE_SYSTEM_NAME}/endian.h")
+    SET(GENERIC_ENDIAN_H "${LIFXD_SOURCE_DIR}/compat/generic/endian.h")
 
     SET(CMAKE_REQUIRED_QUIET TRUE)
     MESSAGE(STATUS "Looking for endian.h")
@@ -9,7 +10,8 @@
     UNSET(CMAKE_REQUIRED_QUIET)
 
     IF (HAVE_ENDIAN_H)
-        MESSAGE(STATUS "Looking for clock_gettime - found")
+        MESSAGE(STATUS "Looking for endan.h - found")
+        SET(ENDIAN_H_PATH "using native headers" CACHE INTERNAL "endian.h path")
     ELSEIF (EXISTS "${COMPAT_ENDIAN_H}")
         MESSAGE(STATUS "Looking for endian.h - not found, using built-in compatibility file")
         FILE(COPY "${COMPAT_ENDIAN_H}" DESTINATION "${LIFXD_BINARY_DIR}/compat/")
diff --git a/core/broadcast.c b/core/broadcast.c
--- a/core/broadcast.c
+++ b/core/broadcast.c
@@ -173,7 +173,6 @@
     assert(lifxd_broadcast_endpoint.socket != -1);
 
     struct sockaddr_in lifx_addr = {
-        .sin_len = sizeof(lifx_addr),
         .sin_family = AF_INET,
         .sin_addr = { INADDR_BROADCAST },
         .sin_port = htons(lifxd_opts.master_port)
@@ -320,7 +319,6 @@
     }
 
     struct sockaddr_in lifx_addr = {
-        .sin_len = sizeof(lifx_addr),
         .sin_family = AF_INET,
         .sin_addr = { INADDR_ANY },
         .sin_port = htons(lifxd_opts.master_port)
diff --git a/core/gateway.c b/core/gateway.c
--- a/core/gateway.c
+++ b/core/gateway.c
@@ -177,7 +177,7 @@
         lifxd_warn("can't open a new socket");
         goto error_socket;
     }
-    if (connect(gw->socket, (const struct sockaddr *)peer, peer->ss_len) == -1
+    if (connect(gw->socket, (const struct sockaddr *)peer, sizeof(*peer)) == -1
         || evutil_make_socket_nonblocking(gw->socket) == -1) {
         lifxd_warn("can't open a new socket");
         goto error_connect;
@@ -197,7 +197,7 @@
         lifxd_gateway_refresh_callback,
         gw
     );
-    memcpy(&gw->peer, peer, peer->ss_len);
+    memcpy(&gw->peer, peer, sizeof(*peer));
     lifxd_sockaddrtoa(peer, gw->ip_addr, sizeof(gw->ip_addr));
     gw->port = lifxd_sockaddrport(peer);
     memcpy(gw->site, site, sizeof(gw->site));
@@ -244,7 +244,7 @@
     struct lifxd_gateway *gw, *next_gw;
     LIST_FOREACH_SAFE(gw, &lifxd_gateways, link, next_gw) {
         if (peer->ss_family == gw->peer.ss_family
-            && !memcmp(&gw->peer, peer, peer->ss_len)) {
+            && !memcmp(&gw->peer, peer, sizeof(*peer))) {
             return gw;
         }
     }
@@ -269,11 +269,12 @@
 {
     assert(gw);
     assert(hdr);
+    assert(pkt_size >= 0 && pkt_size < LIFXD_MAX_PACKET_SIZE);
     assert(!memcmp(hdr->site, gw->site, LIFXD_ADDR_LENGTH));
 
     evbuffer_add(gw->write_buf, hdr, sizeof(*hdr));
     if (pkt) {
-        assert(pkt_size == le16toh(hdr->size) - sizeof(*hdr));
+        assert((unsigned)pkt_size == le16toh(hdr->size) - sizeof(*hdr));
         evbuffer_add(gw->write_buf, pkt, pkt_size);
     }
     event_add(gw->write_ev, NULL);
diff --git a/core/log.c b/core/log.c
--- a/core/log.c
+++ b/core/log.c
@@ -60,7 +60,7 @@
     }
     // '2015-01-02T10:13:16.132222+00:00'
     snprintf(
-        strbuf, bufsz, "%d-%02d-%02dT%02d:%02d:%02d.%d+%02ld:%02ld",
+        strbuf, bufsz, "%d-%02d-%02dT%02d:%02d:%02d.%ld+%02ld:%02ld",
         1900 + tm_now.tm_year, 1 + tm_now.tm_mon, tm_now.tm_mday,
         tm_now.tm_hour, tm_now.tm_min, tm_now.tm_sec,
         now.tv_usec, tm_now.tm_gmtoff / 60 / 60,
